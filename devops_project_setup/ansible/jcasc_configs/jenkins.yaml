jenkins:
  systemMessage: "Managed by JCasC and Ansible"
  numExecutors: 0
  mode: EXCLUSIVE
  slaveAgentPort: 50000
  securityRealm:
    local:
      allowsSignup: false
      users:
       - id: "admin"
         password: "${JENKINS_ADMIN_PASSWORD}"
  
  # 1. AUTH STRATEGY
  # Anonymous users can READ (needed to hit the webhook URL), 
  # but they cannot Trigger builds unless they have the Secret Token (HMAC).
  authorizationStrategy:
    loggedInUsersCanDoAnything:
      allowAnonymousRead: true
  
  nodes:
  - permanent:
      labelString: "docker-worker" 
      mode: NORMAL
      name: "jenkins-node-1"
      numExecutors: 2
      remoteFS: "/home/jenkins"
      launcher:
        jnlp:
          workDirSettings:
            disabled: true
            failIfWorkDirIsMissing: false
            internalDir: "remoting"
            workDirPath: "/tmp"

# 2. CREDENTIALS SETUP
credentials:
  system:
    domainCredentials:
      - credentials:
          # Docker Hub Login
          - usernamePassword:
              scope: GLOBAL
              id: "dockerhub-creds"
              username: "${DOCKER_HUB_USER}"
              password: "${DOCKER_HUB_PASS}"
              description: "Docker Hub Login"
          
          # Docker Hub Username (String for tagging)
          - string:
              scope: GLOBAL
              id: "dockerhub-username"
              secret: "${DOCKER_HUB_USER}"
              description: "Docker Hub Username String"
          
          # GitHub Webhook Secret (HMAC Validation)
          - string:
              scope: GLOBAL
              id: "github-webhook-secret"
              secret: "${WEBHOOK_SECRET}"
              description: "GitHub Webhook Shared Secret"

# 3. GITHUB PLUGIN CONFIG
# This tells Jenkins: "Don't trust just anyone. Only trust webhooks signed with this secret."
unclassified:
  githubpluginconfig:
    hookSecretConfigs:
      - credentialsId: "github-webhook-secret"

# 4. JOB DEFINITION
jobs:
  - script: >
      pipelineJob('Domain-Monitoring-CI') {
        
        // FIX: Explicitly enable the GitHub trigger here.
        // This ensures the job listens to the webhook BEFORE the first run.
        triggers {
          githubPush()
        }

        definition {
          cpsScm {
            scm {
              git {
                remote { url('https://github.com/Tomer-ui/domain-monitor-system2.git') }
                branch('main')
              }
            }
            scriptPath('Jenkinsfile')
          }
        }
      }