---
# ==========================================
# PLAY 1: COMMON CONFIGURATION
# ==========================================
- name: Configure Common Dependencies
  hosts: all
  become: yes
  tasks:
    - name: Create and Enable Swap (2GB)
      shell: |
        swapoff /swapfile || true
        dd if=/dev/zero of=/swapfile bs=128M count=16
        chmod 0600 /swapfile
        mkswap /swapfile
        swapon /swapfile
        grep -q '/swapfile' /etc/fstab || echo '/swapfile none swap sw 0 0' >> /etc/fstab

    - name: Update Apt Cache
      apt:
        update_cache: yes

    - name: Install Prerequisite Packages
      apt:
        name: [apt-transport-https, ca-certificates, curl, software-properties-common, python3-pip, unzip, openjdk-17-jre, jq, gnupg]
        state: present

    - name: Add Docker GPG Key and Repo
      shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
        add-apt-repository -y "deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable"

    - name: Install Docker & Python SDK
      apt:
        name: docker-ce
        state: present
    
    - name: Install Python Docker Library
      pip:
        name: docker
        extra_args: "--break-system-packages"

    - name: Add ubuntu to docker group
      user: { name: ubuntu, groups: docker, append: yes }

# ==========================================
# PLAY 2: MASTER SETUP
# ==========================================
- name: Configure Jenkins Master
  hosts: master
  become: yes
  vars_files: [secrets.yml]
  
  tasks:
    - name: Create Config Dirs
      file: { path: /var/jenkins_home/casc_configs, state: directory, mode: '0777' }

    - name: Copy JCasC File
      copy:
        src: ./jcasc_configs/jenkins.yaml
        dest: /var/jenkins_home/casc_configs/jenkins.yaml

    # 1. Start Jenkins Master
    - name: Start Jenkins Master
      docker_container:
        name: jenkins-master
        image: jenkins/jenkins:lts-jdk17
        state: started
        restart_policy: always
        ports: ["8080:8080", "50000:50000"]
        volumes:
          - /var/jenkins_home/casc_configs:/var/jenkins_home/casc_configs
          - jenkins_data:/var/jenkins_home
        env:
          CASC_JENKINS_CONFIG: /var/jenkins_home/casc_configs/jenkins.yaml
          JAVA_OPTS: "-Xmx384m -Djenkins.install.runSetupWizard=false"
          JENKINS_ADMIN_PASSWORD: "{{ my_jenkins_pass }}"
          DOCKER_HUB_USER: "{{ docker_hub_user }}"
          DOCKER_HUB_PASS: "{{ docker_hub_pass }}"
          WEBHOOK_SECRET: "{{ webhook_secret }}"

    # 2. Install Plugins
    - name: Install Jenkins Plugins
      shell: |
        docker exec -u root jenkins-master \
        jenkins-plugin-cli --plugins configuration-as-code git github job-dsl workflow-aggregator pipeline-stage-view docker-plugin docker-workflow plain-credentials matrix-auth ws-cleanup
      register: plugin_result
      changed_when: "'Downloaded' in plugin_result.stdout"

    # 3. Permissions & Restart
    - name: Fix Jenkins Home Permissions
      shell: docker exec -u root jenkins-master chown -R 1000:1000 /var/jenkins_home

    - name: Restart Jenkins
      docker_container:
        name: jenkins-master
        state: started
        restart: yes

    # 4. Wait for Ready
    - name: Wait for Jenkins to be ready
      uri:
        url: "http://localhost:8080/login"
        status_code: 200
      register: result
      until: result.status == 200
      retries: 40
      delay: 3

    # 5. Get Secret (Cookie Jar Method)
    - name: Get Jenkins Node Secret
      shell: |
        CRUMB=$(curl -s 'http://localhost:8080/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,":",//crumb)' -u "admin:{{ my_jenkins_pass }}" -c /tmp/cookies)
        curl -s -X POST 'http://localhost:8080/scriptText' \
             -u "admin:{{ my_jenkins_pass }}" \
             -b /tmp/cookies \
             -H "$CRUMB" \
             --data-urlencode "script=println(jenkins.model.Jenkins.instance.getNode('jenkins-node-1')?.computer?.jnlpMac)"
      register: secret_output
      until: secret_output.stdout != "null" and secret_output.stdout != ""
      retries: 20
      delay: 3

# ==========================================
# PLAY 3: NODE SETUP (Systemd & Tools)
# ==========================================
- name: Configure Jenkins Node (Native)
  hosts: node
  become: yes
  vars:
    master_private_ip: "{{ hostvars[groups['master'][0]]['private_ip'] }}"
    node_secret: "{{ hostvars[groups['master'][0]]['secret_output']['stdout'] }}"
    workspace_dir: "/home/ubuntu/jenkins_ws"
  
  tasks:
    # --- Dependencies (Chrome & Driver) ---
    - name: Install Google Chrome
      shell: |
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | gpg --dearmor > /usr/share/keyrings/google-chrome.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list
        apt-get update
        apt-get install -y google-chrome-stable
      args:
        creates: /usr/bin/google-chrome

    # FIXED TASK: Uses the 'Stable' channel endpoint instead of exact version matching
    - name: Install Chromedriver
      shell: |
        DOWNLOAD_URL=$(curl -s https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json | jq -r '.channels.Stable.downloads.chromedriver[] | select(.platform=="linux64") | .url')
        wget -O /tmp/chromedriver.zip $DOWNLOAD_URL
        unzip -o /tmp/chromedriver.zip -d /tmp/
        mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/
        chmod +x /usr/local/bin/chromedriver
      args:
        creates: /usr/local/bin/chromedriver

    # --- Setup Workspace & Service ---
    
    - name: Stop Service before updating jar
      systemd:
        name: jenkins-worker
        state: stopped
      ignore_errors: yes

    - name: Create Workspace Directory
      file:
        path: "{{ workspace_dir }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Download Agent JAR from Master
      get_url:
        url: "http://{{ master_private_ip }}:8080/jnlpJars/agent.jar"
        dest: "{{ workspace_dir }}/agent.jar"
        owner: ubuntu
        group: ubuntu
        mode: '0644'
        force: yes

    - name: Create Systemd Service File
      copy:
        dest: /etc/systemd/system/jenkins-worker.service
        content: |
          [Unit]
          Description=Jenkins Worker Agent
          After=network.target

          [Service]
          User=ubuntu
          WorkingDirectory={{ workspace_dir }}
          ExecStart=/usr/bin/java -jar {{ workspace_dir }}/agent.jar -jnlpUrl http://{{ master_private_ip }}:8080/computer/jenkins-node-1/jenkins-agent.jnlp -secret {{ node_secret }} -workDir "{{ workspace_dir }}"
          Restart=always
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
    
    - name: Reload and Start Jenkins Agent Service
      systemd:
        name: jenkins-worker
        state: started
        enabled: yes
        daemon_reload: yes